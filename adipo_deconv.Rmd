---
title: "Decovlution of differentiating adipoyctes"
author: "Mahmoud Shaaban"
date: "2/3/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

# Loading data

```{r load_libraries}
library(debCAM)
library(reshape2)
library(tidyverse)
library(SummarizedExperiment)
library(clusterProfiler)
library(org.Mm.eg.db)
library(GO.db)
library(pdist)
```

## 3T3-L1 mouse cell line

```{r mouse_cell}
# load gene counts
load('data/adipo_counts.rda')

# subset the data
mat <- assay(adipo_counts) 
time <- adipo_counts$time 
stage <- adipo_counts$stage
```

```{r mouse_mds}
# multidimensional scaling
mds <- cmdscale(dist(t(log2(mat + 1))))
mds <- as.data.frame(mds)
```

```{r }
(as_tibble(mds) %>%
    mutate(stage = stage) %>%
    ggplot(aes(x = V1, y = V2, color = as.factor(stage))) +
    geom_point() +
    labs(x = 'Dimension One',
         y = 'Dimension Two',
         color = 'Differentiation') +
    theme_linedraw() +
    theme(legend.position = 'top')) %>%
    ggsave(plot = .,
           filename = 'manuscript/mds.png',
           height = 9, width = 9, units = 'cm')
```

```{r}
# set a seed
set.seed(111)

# run deconvolution
rCAM <- CAM(mat,
            K = 2:5,
            thres.low = 0.30,
            thres.high = 0.95,
            cores = 4)
```

```{r mdl}
# plot mdl
mdl <- MDL(rCAM)
```

```{r}
(tibble(Data = mdl@datalengths,
        Model = mdl@mdls,
        k = mdl@K) %>%
    gather(key, val, -k) %>%
    ggplot(aes(x = k, y = val, group = key, color = key)) +
    geom_point() +
    geom_line(size = 1.2) +
    scale_y_continuous(labels = scales::scientific) + 
    labs(x = 'Number of Sources', y = 'Code Length', color = '') +
    theme_linedraw() + 
    theme(legend.position = 'top')) %>%
    ggsave(plot = .,
           filename = 'manuscript/mdl.png',
           height = 9, width = 9, units = 'cm')
```

```{r}
# extract estimate matrices and markers
n <- 3
aset <- Amat(rCAM, n)
sset <- Smat(rCAM, n)
markers <- MGsforA(rCAM, n)
```

```{r}
(aset %>%
    as_tibble() %>%
    setNames(paste0('P', 1:3)) %>%
    mutate(time = time) %>%
    gather(pop, frac, -time) %>%
    ggplot(aes(x = time, y = frac, color = pop, group = pop)) +
    geom_point() +
    geom_smooth(se = FALSE) +
    labs(x = 'Time Point (hour)', y = 'Fraction of Cells',
         color = 'Sub-population') + 
    theme_linedraw() + 
    theme(legend.position = 'top')) %>%
    ggsave(plot = .,
           filename = 'manuscript/fraction_time.png',
           height = 9, width = 9, units = 'cm',)
```

```{r}
simplex <- debCAM::simplexplot(mat,
                    aset,
                    markers,
                    plot = FALSE)
```

```{r}
df <- as_tibble(t(simplex)) %>%
    mutate(gene = rownames(t(simplex))) %>%
    left_join(melt(markers) %>% setNames(c('gene', 'pop'))) %>%
    mutate(pop = ifelse(!is.na(pop), paste0('P', pop), NA))
(df %>%
    ggplot(aes(x = V1, y = V2)) +
    geom_point(color = 'gray') +
    geom_point(data = na.omit(df), aes(color = pop)) + 
    labs(x = 'Dimension One', y = 'Dimension Two',
         color = 'Sup-Population') +
    theme_linedraw() + 
    theme(legend.position = 'top')) %>%
    ggsave(plot = .,
           filename = 'manuscript/simplexplot.png',
           height = 9, width = 9, units = 'cm',)
```

```{r}
# perform enrichment analysis on the markers
# extract annotations
symbols <- keys(org.Mm.eg.db, 'SYMBOL')
term2gene <- AnnotationDbi::select(org.Mm.eg.db,
                    symbols,
                    'GO',
                    'SYMBOL') %>%
    dplyr::select(term = GO, gene = SYMBOL) %>%
    unique()

terms <- as.data.frame(GOTERM)
terms <- tibble(ID = terms$go_id,
                term = terms$Term,
                definition = terms$Definition,
                ontology = terms$Ontology)

markers_symbols <- map(markers, intersect, y = unique(term2gene$gene))

# run enrichment
comp <- map_df(markers_symbols,
            function(x) {
                enricher(x,
                         TERM2GENE = term2gene,
                         pAdjustMethod = 'fdr')@result
            }, .id = 'population')
```

```{r}
# merge annotation and enrichemnt
inner_join(terms, comp) %>%
    dplyr::filter(p.adjust < .2, Count > 2) %>%
    unique() %>%
    group_by(population, ontology) %>%
    write_csv('manuscript/marker_enrichment.csv')
```

```{r}
# plot the adipogenic markers
adipo_markers <- list('Adipogenic' = c('Pparg', 'Cebpb', 'Cebpa'),
                      'Lipogenic' = c('Lpl', 'Acly', 'Fasn'))

adipo_mat <- sset[rownames(sset) %in% unlist(adipo_markers),]

colnames(adipo_mat) <- paste0('P', 1:3)
adipo_mat <- adipo_mat[unlist(adipo_markers), c(1, 3, 2)]
(melt(log2(adipo_mat + 1)) %>%
    ggplot(aes(x = Var2, y = Var1, fill = value)) +
    geom_tile() +
    scale_fill_gradient(low = 'white', high = 'darkblue') +
    theme_minimal() +
    labs(x = '', y = '', fill = 'Expression')) %>%
    ggsave(plot = .,
           filename = 'manuscript/adipogenic_markers.png',
           height = 7, width = 8, units = 'cm')
```

```{r}
markers_stats <- MGstatistic(mat + .01,
                             aset,
                             boot.alpha = 0.05,
                             nboot = 1000,
                             cores = 4)
```

```{r}
(markers_stats %>%
    rownames_to_column('gene') %>%
    dplyr::filter(gene %in% unlist(markers), OVE.FC != Inf, !grepl('Rik', gene)) %>%
    mutate(idx = paste0('P', idx),
           gene = fct_reorder(gene, OVE.FC)) %>%
    group_by(idx) %>%
    dplyr::slice(1:5) %>%
    ggplot(aes(x = gene, y = log2(OVE.FC))) +
    geom_col() +
    scale_y_continuous(limits = c(0,6.2), expand = c(0, .1)) +
    facet_wrap(~idx, scales = 'free_x') +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          strip.background = element_blank(),
          panel.spacing = unit(-.05, 'cm')) +
    labs(x = '', y = 'Fold-change (log_2)')) %>%
    ggsave(plot = .,
           filename = 'manuscript/markers_fc.png', 
           height = 7, width = 9, units = 'cm')
```

```{r}
# primary adipocytes
primary_se <- read_rds('data/primary_adipocyte.rds')

primary_mat <- 2 ^ na.omit(exprs(primary_se))
group <- primary_se$group
```

```{r}

new_markers <- map(markers, function(x) {
                       intersect(toupper(x), rownames(primary_mat))
                   })

rre <- redoASest(primary_mat, new_markers, maxIter = 10)
```

```{r}
df <- as_tibble(rre$Aest) %>%
    setNames(paste0('P', 1:3)) %>%
    mutate(group = factor(group, levels = c('NDf', 'Df'))) %>%
    gather(pop, frac, -group)
ave <- df %>% group_by(pop, group) %>% summarise(frac = mean(frac))

(df %>% 
    ggplot() +
    geom_jitter(aes(x = group, y = frac, color = pop, group = pop),
                width = .1) +
    geom_point(data = ave, 
               aes(x = group, y = frac, color = pop, group = pop)) +
    geom_line(data = ave, aes(x = group, y = frac, color = pop, group = pop), size = 1) +
    theme_linedraw() +
    theme(legend.position = 'top') +
    labs(x = '', y = 'Fraction of Cells', color = 'Sub-population')) %>%
    ggsave(plot = .,
           filename = 'manuscript/primary_adipocytes.png', 
           height = 9, width = 9, units = 'cm')
```

```{r}
ind <- intersect(toupper(rownames(sset)), rownames(rre$Sest))

mm <- sset
rownames(mm) <- toupper(rownames(mm))

mm <- mm[ind,]
hs <- rre$Sest[ind,]

all(toupper(rownames(mm)) == rownames(hs))

d <- as.matrix(pdist(t(log2(mm + 1)), t(log2(hs + 1))))
rownames(d) <- paste0('P', 1:3)
colnames(d) <- paste0('P', 1:3)
```

```{r}
(melt((d)/100) %>%
    ggplot(aes(x = Var1, y = Var2, fill = value)) +
    geom_tile() +
    theme_minimal() +
    scale_fill_gradient(low = 'white', high = 'darkblue') +
    labs(x = 'Mouse 3T3-L1 Model',
         y = 'Human Primary Adipocyte',
         fill = 'Distance')) %>%
    ggsave(plot = .,
           filename = 'manuscript/distances.png',
           height = 7, width = 9, units = 'cm')
```

```{r}
peak_counts <- read_rds('data/peak_counts.rds')

table(peak_counts$factor == 'POLR2A')
se_pol <- peak_counts[, grepl('POLR2A', peak_counts$factor)]

mat_pol <- assay(se_pol) %>%
    as_tibble() %>%
    mutate(gene = as.character(mcols(se_pol)$geneId)) %>%
    group_by(gene) %>%
    summarise_all(sum) %>%
    ungroup() %>%
    column_to_rownames('gene')

rre_pol <- redoASest(mat_pol, markers, maxIter = 10)

head(rre_pol$Aest)
(rre_pol$Aest %>%
    as_tibble() %>%
    setNames(paste0('P', 1:3)) %>%
    mutate(time = se_pol$time) %>%
    gather(pop, frac, -time) %>%
    ggplot(aes(x = time, y = frac, color = pop, group = pop)) +
    geom_point() +
    geom_smooth(se = FALSE) +
    labs(x = 'Time Point (hour)', y = 'Fraction of Cells',
         color = 'Sub-population') + 
    theme_linedraw() + 
    theme(legend.position = 'top')) %>%
    ggsave(plot = .,
           filename = 'manuscript/fraction_time_trans.png',
           height = 9, width = 9, units = 'cm')
```

```{r}
iterated_rre <- rerun(100, {
    m <- map(markers, ~sample(.x, 35))
    a <- redoASest(mat,
              m,
              maxIter = 2,
              methy = FALSE)
    a$Aest %>%
    as_tibble() %>%
    setNames(paste0('P', 1:3)) %>%
    mutate(time = adipo_counts$time)
}) %>%
    bind_rows(.id = 'iteration')
```

```{r}
(iterated_rre %>%
    gather(pop, frac, -time,-iteration) %>%
    ggplot(aes(y = frac, x = time,group = iteration)) +
    geom_smooth() +
    facet_wrap(~pop, nrow = 1) +
    labs(x = 'Time Point (hour)', y = 'Fraction of Cells',
         color = 'Sub-population') + 
    theme_bw() + 
    theme(panel.spacing = unit(-.05, 'cm'),
          strip.background = element_blank())) %>%
    ggsave(plot = .,
           filename = 'manuscript/fraction_time_iterations.png',
           height = 7, width = 12, units = 'cm')
```

